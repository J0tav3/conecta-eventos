<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste da API de Inscri√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1>Teste da API de Inscri√ß√µes</h1>
        <p class="text-muted">Use esta p√°gina para testar o sistema de inscri√ß√µes em eventos.</p>

        <!-- Configura√ß√µes -->
        <div class="test-section">
            <h3>Configura√ß√µes do Teste</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="eventId" class="form-label">ID do Evento:</label>
                    <input type="number" class="form-control" id="eventId" value="5" min="1">
                </div>
                <div class="col-md-6">
                    <label for="apiUrl" class="form-label">URL da API:</label>
                    <input type="text" class="form-control" id="apiUrl" value="/api/subscriptions.php">
                </div>
            </div>
        </div>

        <!-- Status do Sistema -->
        <div class="test-section">
            <h3>Status do Sistema</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-info" onclick="checkSystemStatus()">Verificar Sistema</button>
                    <button class="btn btn-secondary" onclick="checkEventStatus()">Status do Evento</button>
                </div>
                <div class="col-md-6">
                    <div id="systemStatus" class="alert alert-secondary">
                        <small>Clique em "Verificar Sistema" para ver o status</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testes de Inscri√ß√£o -->
        <div class="test-section">
            <h3>Testes de Inscri√ß√£o</h3>
            <div class="row">
                <div class="col-md-8">
                    <div class="btn-group mb-3" role="group">
                        <button class="btn btn-primary" onclick="testSubscription()">Testar Inscri√ß√£o</button>
                        <button class="btn btn-warning" onclick="checkSubscriptionStatus()">Verificar Status</button>
                        <button class="btn btn-danger" onclick="testUnsubscription()">Testar Cancelamento</button>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observa√ß√µes (opcional):</label>
                        <textarea class="form-control" id="observacoes" rows="2" placeholder="Adicione observa√ß√µes para a inscri√ß√£o..."></textarea>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <strong>Nota:</strong> Voc√™ precisa estar logado como participante para testar as inscri√ß√µes.
                    </div>
                </div>
            </div>
        </div>

        <!-- Log de Atividades -->
        <div class="test-section">
            <h3>Log de Atividades</h3>
            <div class="d-flex justify-content-between mb-2">
                <span>Logs dos testes realizados:</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">Limpar Log</button>
            </div>
            <div id="logArea" class="log-area">
                Aguardando testes...\n
            </div>
        </div>

        <!-- Informa√ß√µes de Debug -->
        <div class="test-section">
            <h3>Debug do Sistema</h3>
            <button class="btn btn-secondary" onclick="getDebugInfo()">Obter Informa√ß√µes de Debug</button>
            <div id="debugInfo" class="mt-3"></div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('logArea');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            logArea.textContent = 'Log limpo.\n';
        }

        async function makeApiRequest(method, data = null) {
            const eventId = document.getElementById('eventId').value;
            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                log(`Fazendo requisi√ß√£o ${method} para ${apiUrl}`);
                
                let options = {
                    method: method,
                    credentials: 'same-origin'
                };

                if (method === 'POST' && data) {
                    const formData = new FormData();
                    formData.append('event_id', eventId);
                    if (data.observacoes) {
                        formData.append('observacoes', data.observacoes);
                    }
                    options.body = formData;
                } else if (method === 'DELETE') {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify({ event_id: eventId });
                } else if (method === 'GET') {
                    const url = new URL(apiUrl, window.location.origin);
                    url.searchParams.append('event_id', eventId);
                    options = { ...options, method: 'GET' };
                    
                    const response = await fetch(url.toString(), options);
                    return await handleResponse(response);
                }

                const response = await fetch(apiUrl, options);
                return await handleResponse(response);
                
            } catch (error) {
                log(`Erro na requisi√ß√£o: ${error.message}`, 'error');
                return null;
            }
        }

        async function handleResponse(response) {
            log(`Resposta recebida: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                log(`Erro HTTP: ${response.status}`, 'error');
                const text = await response.text();
                log(`Conte√∫do da resposta: ${text}`, 'error');
                return null;
            }

            try {
                const data = await response.json();
                log(`Dados JSON: ${JSON.stringify(data, null, 2)}`);
                return data;
            } catch (error) {
                log(`Erro ao parsear JSON: ${error.message}`, 'error');
                const text = await response.text();
                log(`Conte√∫do bruto: ${text}`, 'warning');
                return null;
            }
        }

        async function testSubscription() {
            log('üß™ Iniciando teste de inscri√ß√£o...', 'info');
            const observacoes = document.getElementById('observacoes').value;
            
            const result = await makeApiRequest('POST', { observacoes });
            
            if (result) {
                if (result.success) {
                    log('‚úÖ Inscri√ß√£o realizada com sucesso!', 'success');
                } else {
                    log(`‚ùå Falha na inscri√ß√£o: ${result.message}`, 'error');
                }
            }
        }

        async function checkSubscriptionStatus() {
            log('üîç Verificando status de inscri√ß√£o...', 'info');
            
            const result = await makeApiRequest('GET');
            
            if (result) {
                if (result.success) {
                    if (result.subscribed) {
                        log('‚úÖ Usu√°rio est√° inscrito no evento', 'success');
                        log(`Detalhes: ${JSON.stringify(result.data, null, 2)}`);
                    } else {
                        log('‚ÑπÔ∏è Usu√°rio n√£o est√° inscrito no evento', 'info');
                    }
                } else {
                    log(`‚ùå Erro ao verificar status: ${result.message}`, 'error');
                }
            }
        }

        async function testUnsubscription() {
            log('üß™ Iniciando teste de cancelamento...', 'info');
            
            const result = await makeApiRequest('DELETE');
            
            if (result) {
                if (result.success) {
                    log('‚úÖ Inscri√ß√£o cancelada com sucesso!', 'success');
                } else {
                    log(`‚ùå Falha no cancelamento: ${result.message}`, 'error');
                }
            }
        }

        async function checkSystemStatus() {
            log('üîß Verificando status do sistema...', 'info');
            
            try {
                const response = await fetch('/debug_subscriptions.php', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const debugData = await response.json();
                    
                    const statusDiv = document.getElementById('systemStatus');
                    let statusHtml = '<strong>Status do Sistema:</strong><br>';
                    
                    // Verificar banco de dados
                    if (debugData.database_test.status === 'connected') {
                        statusHtml += '‚úÖ Banco de dados: Conectado<br>';
                    } else {
                        statusHtml += '‚ùå Banco de dados: Problema<br>';
                    }
                    
                    // Verificar arquivos
                    if (debugData.files_check.api_exists) {
                        statusHtml += '‚úÖ API: Arquivo existe<br>';
                    } else {
                        statusHtml += '‚ùå API: Arquivo n√£o encontrado<br>';
                    }
                    
                    // Verificar sess√£o
                    if (debugData.session_data.logged_in) {
                        statusHtml += `‚úÖ Usu√°rio: Logado como ${debugData.session_data.user_type}<br>`;
                    } else {
                        statusHtml += '‚ö†Ô∏è Usu√°rio: N√£o logado<br>';
                    }
                    
                    statusDiv.innerHTML = statusHtml;
                    statusDiv.className = 'alert alert-info';
                    
                    log('‚úÖ Status do sistema verificado com sucesso', 'success');
                } else {
                    log('‚ùå Erro ao verificar status do sistema', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar sistema: ${error.message}`, 'error');
            }
        }

        async function checkEventStatus() {
            const eventId = document.getElementById('eventId').value;
            log(`üîç Verificando status do evento ID: ${eventId}...`, 'info');
            
            try {
                const response = await fetch(`/debug_subscriptions.php?event_id=${eventId}`, {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const debugData = await response.json();
                    
                    if (debugData.event_test) {
                        if (debugData.event_test.found) {
                            log('‚úÖ Evento encontrado no banco de dados', 'success');
                            log(`T√≠tulo: ${debugData.event_test.event_data.titulo}`);
                            log(`Status: ${debugData.event_test.event_data.status}`);
                            log(`Total de inscri√ß√µes: ${debugData.event_test.total_inscricoes}`);
                        } else {
                            log('‚ùå Evento n√£o encontrado no banco de dados', 'error');
                        }
                    }
                } else {
                    log('‚ùå Erro ao verificar evento', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function getDebugInfo() {
            log('üîß Obtendo informa√ß√µes de debug...', 'info');
            
            try {
                const response = await fetch('/debug_subscriptions.php', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const debugData = await response.json();
                    
                    const debugDiv = document.getElementById('debugInfo');
                    debugDiv.innerHTML = `<pre class="bg-light p-3 border rounded">${JSON.stringify(debugData, null, 2)}</pre>`;
                    
                    log('‚úÖ Informa√ß√µes de debug obtidas', 'success');
                } else {
                    log('‚ùå Erro ao obter debug', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina de teste carregada');
            log('‚ÑπÔ∏è Configure o ID do evento e clique nos bot√µes para testar');
        });
    </script>
</body>
</html>